---
title: 腾讯云日志产品CLS使用以及成本控制的最佳实践
date: 2023-05-19 09:15:57
permalink: /pages/d4534a/
categories:
  - 运维观止
  - 最佳实践
  - 成本优化实践
tags:
  -
feed:
  enable: true
description: 日志成本控制主要有如下几个维度：- 减量：去掉没有意义的无效日志，只打印关键日志。- 减周期：尽可能减少日志存储的时长。- 转低频：低频相较于标准存储，可降低 6 0%--70%的成本。- 慎开全文索引：全文索引将会把所有日志全部索引一遍，并且这个存储是未压缩的存储，如果开启全文索引，则存储往往会比不开的存储高出 4--10 倍。
---

## 前言

日志成本控制主要有如下几个维度：

- 减量：去掉没有意义的无效日志，只打印关键日志。

- 减周期：尽可能减少日志存储的时长。

- 转低频：低频相较于标准存储，可降低 6 0%--70%的成本。

- 慎开全文索引：全文索引将会把所有日志全部索引一遍，并且这个存储是未压缩的存储，如果开启全文索引，则存储往往会比不开的存储高出 4--10 倍。

我们需要结合成本控制与实际使用场景，选择合适的接入方案。

## 关于索引存储

在[腾讯云官方文档](https://cloud.tencent.com/document/product/614/45802)中，可以看到关于存储费用上的详细介绍。

![](http://t.eryajf.net/imgs/2023/05/d09320ca6917fc3f.jpg)

此处有两个概念，日志存储和索引存储。

- 日志存储：表示原始日志存到 cls 服务的存储占用，这个存储量配合 Loglistener(官方组件，默认有压缩机制)采集，会有压缩，计价也是算的压缩后的存储费用。

- 索引存储：当我们给该主题的日志开启了索引功能之后，索引后的日志所占用的存储。这个存储计量方式是未压缩的日志。

但是索引存储中，也有三种情况可区分：

| 方案                     | 特性                                                         | 问题点                                                       | 其他                                                         |
| ------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 全文索引                 | 所有内容都会被索引，你可以通过任意关键字或词对日志进行全文检索。 | 所有的日志都会被索引，且索引下来的是未压缩的源日志，因此全文索引占用存储会很大，费用高。 |                                                              |
| 仅开启键值索引           | 以日志中键值进行索引，可以有选择性得进行索引，检索也通过键值对来进行，能够满足检索需求的情况下，减小日志的索引存储量。 | 不支持模糊的全文搜素，支持指定键对应的模糊及确定搜索。依赖日志结构相对清晰规范。 | 关闭全文索引，通过键值索引进行模糊搜索的示例：![](http://t.eryajf.net/imgs/2023/05/f552abe799252db7.jpg) |
| 全文索引和键值索引都开启 | 当开启了全文索引之后，则键值索引不收费，但是仍旧需要单独配置需要索引的键值对。 | 费用高，仍需要配置键值索引，不推荐这种方案。                 |                                                              |

因此，在使用索引存储功能的时候，比较建议使用键值索引进行配置，不建议直接开启全文索引。如下截图是一个例子：

![](http://t.eryajf.net/imgs/2023/05/1c17b7034a70cf18.jpg)

从平均值角度来计算：

```sh
标准存储大约7867G，索引存储量大约44785G，两者相差5倍多
费用计算：
    标准存储：7867*0.0115*30 = 2714
    索引存储：44785*0.0115*30 = 15450
其中 0.0115 表示存储费用单价，每日每G的价格

当然，通常公司使用云产品的时候都会有一个折扣价，因为各家折扣不一，所以这里就以原始价格来进行计算。
```

主要是想说明一个问题：**那就是开启了全文索引的日志主题，每个月花费在标准索引上的费用很高。**

因此核心表达就是：**慎开全文索引，善用键值索引，切勿重建索引。**

## 关于低频存储

日志存储类型方案，[腾讯云官方文档](https://cloud.tencent.com/document/product/614/60019)有一个直观的对比图：

|    功能点     |       低频存储       |        标准存储        |
| :-----------: | :------------------: | :--------------------: |
|   索引建立    | ✓（只支持全文索引）  |           ✓            |
|  上下文检索   |          ✓           |           ✓            |
|   快速分析    |          ×           |           ✓            |
|   全文检索    | ✓（亿条数据 2 秒响应） | ✓（亿条数据 0.5 秒响应） |
|   键值检索    |          ×           |           ✓            |
|   日志下载    |          ✓           |           ✓            |
|   SQL 分析    |          ×           |           ✓            |
|    仪表盘     |          ×           |           ✓            |
|   监控告警    |          ×           |           ✓            |
|  投递到 COS   |          ✓           |           ✓            |
| 投递到 Ckafka |          ✓           |           ✓            |
|   投递到 ES   |          ✓           |           ✓            |
|  投递到 SCF   |          ✓           |           ✓            |
|   日志消费    |          ✓           |           ✓            |
|   数据加工    |          ✓           |           ✓            |

简单分析如下：

- 标准存储：需要实时分析与告警，不需要长期留存的日志，查询响应较快（亿条数据 0.5 秒响应），做 sql 分析，仪表盘，监控告警

- 低频存储：对查询响应速度要求不高（亿条数据 2 秒响应），不需要做 sql 分析，仪表盘，监控告警的，仅有检索回溯需求的，可选择这种

- 标准+低频：可以设置 7 天内的为标准存储，超过 7 天的转为低频。兼顾两个特性，成本控制比较有优势。（目前的问题是仅支持 7 天以上的数据转为低频。）对于必须要存储超过 7 天的日志，可以选择这个方案。

我们仍以上边的截图数据为例，那个主题正是设置了存储 30 天，并且没有开启低频转储的情况，简单看下费用占比：

```
腾讯云费用中心那里，低频存储的费用是 0.0025 每G每天
当前方案
    （标准存储：7867*0.0115*30 = 2714） + （索引存储：44785*0.0115*30 = 15450） ==> 18164
设置7天前转低频的方案
    （标准存储：(7867*0.0115*7)+(7867*0.0025*23) = 1085） + （索引存储：(44785*0.0115*7)+(44785*0.0025*23) = 6180） ==> 7265

两个方案每个月存储费用相差 18164 - 7265 = 10899
```

目前来看，一些业务日志，事实上可以直接放到低频存储当中，连标准 7 天转低频都不需要，这样能够对于成本的节约大概能到 `60%--70%`。

所以一定要**创建专门存放低频日志的主题，这个主题可以开启全文索引**(否则就没法检索了)，经由业务方确认之后，接入进去。

## 关于日志主题

在腾讯云日志服务当中，日志主题是一个相当于 ES 中索引的概念，通常来说，一个索引应该对应一个应用，因为这里边会存在不少以应用维度，字段维度聚合的场景，相对应的，在腾讯云日志中，我们也应该一个主题对应一个应用。这是一个虽然看起来配置相对麻烦，但是收益绝对大的一个事。

一个日志采集的需求从业务方提交到运维手中，应该有如下几个选项：

- 存储周期：默认为 3 天，最多 7 天，超过 7 天的，一定需要配置沉降为低频存储。超过 15 天的，需做特殊说明。超过 30 天的，需要考虑转储到 cos。

- 存储类型：默认为低频存储，如有配置监控告警，绘制大盘，做 sql 分析(目前没有一例)的需求，可选择标准存储。但是要与存储周期做结合。

- 索引配置：默认关闭全文索引，只配置键值索引，即支持根据指定键的关键字进行检索，如特别需要，再开全文索引，一定注意，全文索引要比键值索引成本贵 3--4 倍。

因此作为业务方，需要了解这些概念以及概念背后涉及的特性，从而在提交日志采集需求的时候，做到有的放矢。

针对日志主题，因为一个日志主题对应一个应用，就可以针对性应用实际场景，配置指定的键值索引，以及是否开启全文索引。

## 关于流量

日志服务收费的两个大头：存储与流量。

以上内容基本上都是在存储视角下功夫，其实还有一个维度容易被忽视那就是流量，流量优化大概有两个方向：

- 降低原始无效日志的打印，从源头上控制日志量，是解决成本问题最根本的手段，需要时常应用，因为随着业务开发的递进，无效日志一定也是在不知不觉中越来越多的。

- 还有一个比较重要的手段是：不开全文索引，开启全文索引之后，cls 会将原生日志转为索引的过程产生的流量，作为流量费的一部分，通常这个费用远高于日志传输写入的流量费用。以下是腾讯官方文档对这块儿的说明

![](http://t.eryajf.net/imgs/2023/05/442ca5cddf0177d5.jpg)

- 所以针对这一点，我们应该尽可能避免直接开启全文索引，而选择开启键值索引。

- 另外一个需要格外注意的点就是，一定注意，不要随意点击重建索引按钮，这个按钮会把历史日志重新索引一遍，如果你增加了一个字段，就点击重建索引，那这个操作会将历史保留的日志全部重新索引一遍，会以原日志大小产生索引转换流量费用，成本高昂。

官方文档对此概述为：[重建索引会将指定时间范围内的原始日志重新构建一遍索引，将产生索引流量费用（不产生写流量费用及索引存储费用）。数据量较大时会消耗较长时间并产生较高的费用，建议您尽量避免频繁地修改索引配置并重建索引。](https://cloud.tencent.com/document/product/614/74779)

最后：多看官方文档，奥妙自在其中。